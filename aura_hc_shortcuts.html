<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DBID Ops Dashboard</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    
    /* Header updated for Flexbox layout */
    header { 
      position: sticky; 
      top: 0; 
      z-index: 10; 
      background: Canvas; 
      border-bottom: 1px solid color-mix(in oklab, CanvasText 20%, transparent); 
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      gap: 16px;
    }

    .bar { display: flex; gap: 8px; align-items: center; padding: 12px 14px; flex-wrap: wrap; }
    label { font-weight: 600; }
    
    input[type="text"] {
      width: min(520px, 100%);
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid color-mix(in oklab, CanvasText 20%, transparent);
      background: color-mix(in oklab, Canvas 92%, CanvasText 8%);
      color: CanvasText;
      outline: none;
    }
    
    /* Specific style for the header email input */
    #userEmail {
      width: 250px;
      font-size: 14px;
    }

    button, a.btn {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid color-mix(in oklab, CanvasText 20%, transparent);
      background: color-mix(in oklab, Canvas 88%, CanvasText 12%);
      color: CanvasText;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      width: auto;
      max-width: max-content;
    }
    button:hover, a.btn:hover { background: color-mix(in oklab, Canvas 80%, CanvasText 20%); }
    .hint { opacity: 0.8; font-size: 12px; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; box-sizing: border-box; }
    @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }

    .panel { border: 1px solid color-mix(in oklab, CanvasText 15%, transparent); border-radius: 14px; overflow: hidden; background: Canvas; }
    .panel h2 { margin: 0; padding: 10px 12px; font-size: 14px; border-bottom: 1px solid color-mix(in oklab, CanvasText 12%, transparent); }
    .panel .content { padding: 12px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .note { font-size: 12px; opacity: 0.75; }
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0; font-size:20px;">Aura Health Check shortcuts</h1>
    <input id="userEmail" type="text" placeholder="first.last@neo4j.com" aria-label="User Email Address" />
  </header>

  <main class="grid" style="grid-template-columns: 1fr;">
    <section class="panel">
      <h2>Admin reports workflow</h2>
      <div class="content" style="display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:16px; align-items:start;">
        <div style="display:flex; flex-direction:column; gap:10px;">
          <h3 style="margin:0; font-size:14px;">Find dbid</h3>
          <a id="presetDbLookup" class="btn"  target="_blank" rel="noopener noreferrer">Preset db lookup ↗</a>
          <div>
            <input id="dbid" type="text" inputmode="text" autocomplete="off" placeholder="Enter dbid" list="dbidSuggestions" />
            <datalist id="dbidSuggestions"></datalist>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button id="go" type="button">Update links</button>
            <button id="clear" type="button" title="Clear saved dbids">Clear history</button>
          </div>
          <div class="hint">Previous dbids are saved locally and used for autocomplete.</div>
        </div>

        <div style="display:flex; flex-direction:column; gap:10px;">
          <h3 style="margin:0; font-size:14px;">Generate admin-reports</h3>
          <a id="sreLink" class="btn" target="_blank" rel="noopener noreferrer">SRE Portal Operations ↗</a>
        </div>

        <div style="display:flex; flex-direction:column; gap:10px;">
          <h3 style="margin:0; font-size:14px;">Download admin-reports</h3>
          <a id="gcsLink" class="btn" target="_blank" rel="noopener noreferrer">Open GCP bucket ↗</a>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>Upload to the Health Check online service</h2>
      <div class="content" style="display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:16px; align-items:flex-start;">
        <div>
          <h3 style="margin:0 0 8px 0; font-size:14px;">S3</h3>
          <a id="s3Link" class="btn" target="_blank" rel="noopener noreferrer">Open S3 bucket ↗</a>
          <a id="cppLink" class="btn" target="_blank" rel="noopener noreferrer" style="margin-top:8px;">Find CPP_ID in Preset ↗</a>
          <a class="btn" href="https://console.cloud.google.com/bigquery?ws=!1m7!1m6!12m5!1m3!1sneo4j-padw-prod!2sus-central1!3s77d81879-1f5a-4d0b-a149-c2da39039ce8!2e1" target="_blank" rel="noopener noreferrer">Find CPP_ID in BigQuery ↗</a>
        </div>
        <div>
          <h3 style="margin:0 0 8px 0; font-size:14px;">SFTP</h3>
          <a class="btn" href="https://login.prod.cs-neo4j.com" target="_blank" rel="noopener noreferrer">SFTP 1-time code ↗</a>
          <a id="ftpLink" class="btn" target="_blank" rel="noopener noreferrer">SFTP ↗</a>
          <a id="itermDownloadLink" style="font-size:12px; margin-top:8px; display:inline-block; text-decoration:underline; cursor:pointer; opacity:0.8; color:inherit;">get iTerm SFTP profile ⬇</a>
        </div>
        <div>
          <h3 style="margin:0 0 8px 0; font-size:14px;">HTTP</h3>
          <a class="btn" href="https://admin.upload.support.neo4j.com/" target="_blank" rel="noopener noreferrer">HTTP Upload – User creation ↗</a>
          <a class="btn" href="https://upload.support.neo4j.com" target="_blank" rel="noopener noreferrer">HTTP Upload ↗</a>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>Health Check Reports</h2>
      <div class="content" style="display:flex; flex-direction:column; gap:10px; align-items:flex-start;">
        <a class="btn" href="https://slack.com/app_redirect?channel=cs-health-checks" target="_blank" rel="noopener noreferrer"><img src="https://a.slack-edge.com/80588/marketing/img/icons/icon_slack_hash_colored.png" alt="Slack" style="width:16px; height:16px; flex-shrink:0;"> Get HC report ↗</a>
      </div>
    </section>
  </main>

  <script>
    (function () {
      const STORAGE_KEY = 'dbidHistory.v2';
      const EMAIL_STORAGE_KEY = 'userEmail.v1';
      const MAX_HISTORY = 20;

      const input = document.getElementById('dbid');
      const emailInput = document.getElementById('userEmail');
      const datalist = document.getElementById('dbidSuggestions');
      const goBtn = document.getElementById('go');
      const clearBtn = document.getElementById('clear');
      const sreLink = document.getElementById('sreLink');
      const gcsLink = document.getElementById('gcsLink');
      const s3Link = document.getElementById('s3Link');
      const cppLink = document.getElementById('cppLink');
      const ftpLink = document.getElementById('ftpLink');
      const presetDbLookup = document.getElementById('presetDbLookup');
      
      // New logic for the iTerm Profile Download
      const itermLink = document.getElementById('itermDownloadLink');
      const itermProfile = {
        "Profiles": [
          {
            "Name": "SFTP Handler",
            "Guid": "sftp-handler-shared-profile",
            "Custom Command": "Yes",
            "Command": "bash -c \"if [ -z '$$USER$$' ]; then sftp $$HOST$$; else sftp $$USER$$@$$HOST$$; fi\"",
            "Description": "Profile to handle ftp:// links via sftp",
            "Tags": ["Protocol Handler"],
            "Url Schemes": ["ftp"],
            "Window Type": 0,
            "Close Sessions On End": true
          }
        ]
      };
      // Create a Blob from the JSON and set it as the href
      const blob = new Blob([JSON.stringify(itermProfile, null, 2)], {type: 'application/json'});
      itermLink.href = URL.createObjectURL(blob);
      itermLink.download = 'sftp-handler.json';


      function safeDbid(raw) {
        return String(raw || '').trim();
      }

      function loadHistory() {
        try {
          const parsed = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
          if (Array.isArray(parsed)) return parsed.map(String);
        } catch (_) {}
        return [];
      }

      function saveHistory(list) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(list.slice(0, MAX_HISTORY)));
        } catch (_) {}
      }

      function renderDatalist(list) {
        datalist.innerHTML = '';
        list.forEach((v) => {
          const opt = document.createElement('option');
          opt.value = v;
          datalist.appendChild(opt);
        });
      }

      function setLinks(dbid) {
        const encoded = encodeURIComponent(dbid);
        const currentEmail = emailInput.value.trim() || "first.last@neo4j.com";
        const encodedEmail = encodeURIComponent(currentEmail);
        
        const presetBase = `https://manage.app.preset.io/login/?email=${encodedEmail}&next=`;
        presetDbLookup.href = presetBase + encodeURIComponent(`https://9d89c3b1.us2a.app.preset.io/superset/dashboard/29/?native_filters_key=2m6S656E0IcQzcp6pSM-PYU9qHZ3QamRvbQ4pGIoweA7X_inMGHDCSB6S-87Prwu&email=${encodedEmail}`);
        cppLink.href = presetBase + encodeURIComponent(`https://9d89c3b1.us2a.app.preset.io/superset/dashboard/p/lzBApO4EdL2/?native_filters=(NATIVE_FILTER-Fcf44qNKUQceF55VPxdkb:(extraFormData:(filters:!((col:dbid,op:IN,val:!(%27${encoded}%27)))),filterState:(label:%27${encoded}%27,validateStatus:!f,value:!(%27${encoded}%27),__cache:(value:!(%27${encoded}%27)))),NATIVE_FILTER-vn0Ss5nQldp9Nri8Jgldc:(filterState:(value:!()),scope:!((rootPath:!(),excluded:!())),extraFormData:()),NATIVE_FILTER-SFSwvGWyC9xyxRaaq0RyJ:(filterState:(value:!()),scope:!((rootPath:!(),excluded:!())),extraFormData:()))`);

        sreLink.href = `https://sre.neo4j.io/databases/${encoded}/operations#operationsSection`;
        gcsLink.href = `https://console.cloud.google.com/storage/browser/production-aura-operations-utility-support/production/${encoded}/neo4j-admin-report;tab=objects?prefix=&forceOnObjectsSortingFiltering=false`;
        const awsAccount = '158692621672';
        const awsRole = 'HealthcheckSEAccess';
        const current_YYYYMMDD_date_str = new Date().toISOString().slice(0,10).replace(/-/g, ''); 
        
        const s3Prefix = `healthchecks/${currentEmail}/${dbid}/${current_YYYYMMDD_date_str}/`;
        const s3Url = `https://s3.console.aws.amazon.com/s3/buckets/cs-upload-bucket-prod?region=eu-west-1&prefix=${s3Prefix}&showversions=false`;
        s3Link.href = `https://d-92676bf303.awsapps.com/start/#/console?account_id=${awsAccount}&role_name=${awsRole}&destination=` + encodeURIComponent(s3Url);

        ftpLink.href = `ftp://${currentEmail}@sftp.healthcheck.neo4j.com/`;
      }


      function upsertHistory(dbid) {
        if (!dbid) return;
        const history = loadHistory();
        const next = [dbid, ...history.filter((x) => x !== dbid)];
        saveHistory(next);
        renderDatalist(next);
      }

      function go() {
        const dbid = safeDbid(input.value);
        if (!dbid) return;
        upsertHistory(dbid);
        setLinks(dbid);
      }

      function clearHistory() {
        try { localStorage.removeItem(STORAGE_KEY); } catch (_) {}
        renderDatalist([]);
      }
      
      // Email Handling Functions
      function loadEmail() {
        try {
          return localStorage.getItem(EMAIL_STORAGE_KEY) || "first.last@neo4j.com";
        } catch (_) {
            return "first.last@neo4j.com";
        }
      }
      
      function saveEmail() {
        try {
          localStorage.setItem(EMAIL_STORAGE_KEY, emailInput.value);
        } catch (_) {}
      }

      // Init
      const history = loadHistory();
      renderDatalist(history);
      
      // Init Email
      emailInput.value = loadEmail();
      
      emailInput.focus();

      if (history.length) {
        input.value = history[0];
        setLinks(history[0]);
      }

      // Events
      goBtn.addEventListener('click', go);
      clearBtn.addEventListener('click', clearHistory);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          go();
        }
      });
      input.addEventListener('change', () => {
        const dbid = safeDbid(input.value);
        if (dbid) {
          upsertHistory(dbid);
          setLinks(dbid);
        }
      });
      
      emailInput.addEventListener('change', () => {
          saveEmail();
          const dbid = safeDbid(input.value);
          if (dbid) {
              setLinks(dbid);
          }
      });
      emailInput.addEventListener('input', () => {
         const dbid = safeDbid(input.value);
         if (dbid) {
             setLinks(dbid);
         }
      });

    })();
  </script>
</body>
</html>